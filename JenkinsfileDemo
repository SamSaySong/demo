pipeline {
    agent any

    parameters {
        choice(name: 'ENVIRONMENT', 
               choices: ['staging', 'production'], 
               description: 'Ch·ªçn m√¥i tr∆∞·ªùng ƒë·ªÉ ch·∫°y test')
    }

    environment {
        COMPOSE_CMD = 'docker-compose'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Detect docker-compose') {
            steps {
                script {
                    def detected = sh(
                        script: """
                            if docker compose version >/dev/null 2>&1; then 
                                echo 'docker compose'
                            elif docker-compose --version >/dev/null 2>&1; then 
                                echo 'docker-compose'
                            else 
                                echo 'docker-compose'
                            fi
                        """, 
                        returnStdout: true
                    ).trim()
                    env.COMPOSE_CMD = detected
                    echo "‚úÖ S·ª≠ d·ª•ng l·ªánh: ${env.COMPOSE_CMD}"
                }
            }
        }

        // ‚úÖ FIX: Stage m·ªõi ƒë·ªÉ validate env file
        stage('Validate Environment') {
            steps {
                script {
                    def envFile = (params.ENVIRONMENT == 'production') ? 'production.env' : 'staging.env'
                    
                    echo "üìã Ki·ªÉm tra file m√¥i tr∆∞·ªùng: ${envFile}"
                    
                    // Check file exists
                    if (!fileExists(envFile)) {
                        error("‚ùå File ${envFile} kh√¥ng t·ªìn t·∫°i!")
                    }
                    
                    // Show content for debugging
                    sh "echo 'üìÑ N·ªôi dung ${envFile}:' && cat ${envFile}"
                }
            }
        }

        stage('Build & Run Robot Tests') {
            steps {
                script {
                    def envFile = (params.ENVIRONMENT == 'production') ? 'production.env' : 'staging.env'
                    
                    echo "üöÄ Ch·∫°y test tr√™n [${params.ENVIRONMENT}] v·ªõi file [${envFile}]"

                    // ‚úÖ FIX: Truy·ªÅn ENV_FILE ƒë·ªÉ docker-compose.yml nh·∫≠n ƒë∆∞·ª£c
                    sh """
                        export ENV_FILE=${envFile}
                        ${env.COMPOSE_CMD} --env-file ${envFile} \
                            up --build --force-recreate \
                            --abort-on-container-exit \
                            --exit-code-from robot-test
                    """
                }
            }
        }

        stage('Publish Reports') {
            steps {
                echo 'üìä ƒêang l∆∞u tr·ªØ b√°o c√°o Robot...'
                
                // ‚úÖ FIX: Publish Robot Framework reports v·ªõi plugin
                robot(
                    outputPath: 'results',
                    outputFileName: 'output.xml',
                    reportFileName: 'report.html',
                    logFileName: 'log.html',
                    passThreshold: 80.0,
                    unstableThreshold: 70.0
                )
                
                // Backup: Archive artifacts
                archiveArtifacts artifacts: 'results/*.html, results/*.xml', 
                                 allowEmptyArchive: true
            }
        }
    }

    post {
        always {
            script {
                echo "üßπ D·ªçn d·∫πp container v√† network..."
                sh "${env.COMPOSE_CMD} down -v || true"
            }
        }
        
        success {
            echo "‚úÖ Pipeline th√†nh c√¥ng!"
        }
        
        failure {
            echo "‚ùå Pipeline th·∫•t b·∫°i! Ki·ªÉm tra logs."
        }
    }
}
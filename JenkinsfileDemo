// Jenkinsfile (Declarative Pipeline)

pipeline {
    agent any

    // 2. TẠO LỰA CHỌN MÔI TRƯỜNG
    parameters {
        choice(name: 'ENVIRONMENT', 
               choices: ['staging', 'production'], 
               description: 'Chọn môi trường để chạy test')
    }

    // KHỐI STAGES DUY NHẤT
    stages {
        // 3. LẤY CODE TỪ GIT
        stage('Checkout') {
            steps {
                checkout scm 
            }
        }

        // 4. BUILD IMAGE
        stage('Build Docker Image') {
            steps {
                sh 'docker-compose build'
            }
        }

        // 5. CHẠY TEST (PHẦN QUAN TRỌNG NHẤT)
        stage('Run Robot Tests') {
            steps {
                script {
                    def envFile = 'staging.env'

                    if (params.ENVIRONMENT == 'production') {
                        envFile = 'production.env'
                    }

                    echo "Running tests on ${params.ENVIRONMENT} using ${envFile}"

                    sh "docker-compose --env-file ${envFile} up --exit-code-from robot-test"
                }
            }
        }

        // 6. XUẤT BẢN REPORT (ĐÃ ĐƯỢC DI CHUYỂN VÀO ĐÂY)
        stage('Publish Reports') {
            steps {
                echo 'Archiving Robot Framework reports...'
                
                archiveArtifacts artifacts: 'results/log.html, results/report.html, results/output.xml',
                                 allowEmptyArchive: true
            }
        }
    } // Dấu đóng của khối 'stages'

    // 7. DỌN DẸP (Giữ nguyên)
    post {
        always {
            echo "Dọn dẹp container và network..."
            sh 'docker-compose down'
        }
    }
} // Dấu đóng của khối 'pipeline'
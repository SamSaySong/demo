pipeline {
    agent any

    environment {
        PYTHON_VERSION_TO_INSTALL = '3.10'
        PYTHON_CMD = "python${env.PYTHON_VERSION_TO_INSTALL}"
        VENV_DIR = "venv_robot_project_py${env.PYTHON_VERSION_TO_INSTALL}"
        
        // Th∆∞ m·ª•c ƒë·ªÉ l∆∞u ChromeDriver t·∫°m th·ªùi
        CHROME_DRIVER_DIR = "${pwd()}/chromedriver-linux64"
    }

    stages {
        stage('Checkout Source Code') {
            steps {
                echo 'Starting to clone the Git repository...'
                git branch: 'main', url: 'https://github.com/SamSaySong/demo.git' 
                echo 'Git repository cloned successfully!'
                sh 'ls -la'
            }
        }

        stage('Check and Install Python') {
            steps {
                echo "Checking for Python ${env.PYTHON_VERSION_TO_INSTALL}..."
                script {
                    def pythonExists = sh(script: "command -v ${env.PYTHON_CMD}", returnStatus: true) == 0

                    if (!pythonExists) {
                        echo "Python ${env.PYTHON_VERSION_TO_INSTALL} not found. Attempting to install..."
                        def defaultPython3Version = sh(script: "python3 --version || true", returnStdout: true).trim()
                        if (defaultPython3Version.startsWith("Python ${env.PYTHON_VERSION_TO_INSTALL}")) {
                             echo "Python3 is already version ${env.PYTHON_VERSION_TO_INSTALL}. Using 'python3' command."
                             env.PYTHON_CMD = 'python3'
                        } else {
                            // C·∫£nh b√°o ng∆∞·ªùi d√πng v·ªÅ quy·ªÅn sudo, ƒë√¢y l√† b∆∞·ªõc c√≥ th·ªÉ th·∫•t b·∫°i
                            echo "Proceeding with installation of Python ${env.PYTHON_VERSION_TO_INSTALL}..."
                            echo "WARNING: This step requires a pre-configured Jenkins agent with 'sudo' access for the jenkins user."
                            sh """
                                sudo apt update
                                sudo apt install -y software-properties-common
                                sudo add-apt-repository -y ppa:deadsnakes/ppa
                                sudo apt update
                                sudo apt install -y ${env.PYTHON_CMD} ${env.PYTHON_CMD}-venv
                                echo "Python ${env.PYTHON_VERSION_TO_INSTALL} and venv installed successfully."
                            """
                        }
                    } else {
                        echo "Python ${env.PYTHON_VERSION_TO_INSTALL} is already installed."
                    }

                    def pythonVersionOutput = sh(script: "${env.PYTHON_CMD} --version", returnStdout: true).trim()
                    echo "S·ª≠ d·ª•ng Python: ${pythonVersionOutput}"
                }
            }
        }

        stage('Prepare Python Virtual Environment') {
            steps {
                echo "Creating dedicated virtual environment '${VENV_DIR}' for the project using ${PYTHON_CMD}..."
                script {
                    sh "${env.PYTHON_CMD} -m venv ${env.VENV_DIR}"
                    env.VIRTUAL_ENV_BIN = "${pwd()}/${env.VENV_DIR}/bin"
                    env.PATH = "${env.VIRTUAL_ENV_BIN}:${env.PATH}"
                    echo "Virtual environment created at: ${env.VIRTUAL_ENV_BIN}"
                }
            }
        }

        stage('Download and Configure ChromeDriver') {
            steps {
                script {
                    echo "Downloading ChromeDriver..."
                    def chromeVersion = ""
                    try {
                        // C·ªë g·∫Øng l·∫•y phi√™n b·∫£n Chrome
                        chromeVersion = sh(script: "google-chrome --version | cut -d ' ' -f3 | cut -d '.' -f1", returnStdout: true).trim()
                    } catch (Exception e) {
                        echo "Warning: Cannot detect Google Chrome version. This may cause issues. Using fallback."
                        chromeVersion = "131" // Phi√™n b·∫£n fallback n·∫øu kh√¥ng th·ªÉ ph√°t hi·ªán
                    }
                    echo "Detected Chrome major version: ${chromeVersion}"

                    // L·∫•y JSON data v√† parsing b·∫±ng Groovy
                    def apiUrl = "https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-with-downloads.json"
                    def versionsJson = new groovy.json.JsonSlurper().parse(new URL(apiUrl).newReader())
                    def stableVersionEntry = versionsJson.channels.Stable
                    
                    if (!stableVersionEntry) {
                        error 'Could not find a stable version in the JSON output.'
                    }
                    
                    def stableVersion = stableVersionEntry.version
                    def downloadUrl = stableVersionEntry.downloads.chromedriver.find { it.platform == 'linux64' }.url

                    echo "Detected Stable ChromeDriver version: ${stableVersion}"
                    echo "Download URL: ${downloadUrl}"

                    // Download the ChromeDriver zip file
                    sh "wget ${downloadUrl} -O chromedriver.zip"
                    
                    // Unzip, set permissions, and add to PATH
                    sh "unzip -o chromedriver.zip"
                    sh "chmod +x chromedriver-linux64/chromedriver"
                    env.PATH = "${pwd()}/chromedriver-linux64:${env.PATH}"
                    echo "ChromeDriver has been placed in PATH for this pipeline run."
                    
                    // Verify ChromeDriver works
                    sh "chromedriver --version"
                }
            }
        }

        stage('Install Dependencies') {
            steps {
                echo 'Installing dependencies from requirements.txt into the virtual environment...'
                script {
                    sh "pip install --upgrade pip"
                    if (fileExists('requirements.txt')) {
                        sh "pip install -r requirements.txt"
                        echo "Dependencies from requirements.txt installed successfully."
                    } else {
                        echo "Warning: requirements.txt not found. Skipping dependency installation."
                    }
                    sh "pip install robotframework robotframework-seleniumlibrary"
                    echo "Robot Framework and SeleniumLibrary installed successfully."
                }
            }
        }

        stage('Run Robot Tests') {
            steps {
                echo 'Starting Robot Framework tests with demo.robot...'
                sh "robot -d results demo.robot"
                echo 'Robot Framework tests execution finished.'
            }
        }
    }

    post {
        always {
            echo 'Pipeline finished.'
            script {
                if (fileExists("${env.VENV_DIR}")) {
                    echo "Cleaning up virtual environment: ${env.VENV_DIR}"
                    sh "rm -rf ${env.VENV_DIR}"
                    echo "Virtual environment ${env.VENV_DIR} removed."
                }
                
                if (fileExists("${env.CHROME_DRIVER_DIR}")) {
                    echo "Cleaning up ChromeDriver temporary directory: ${env.CHROME_DRIVER_DIR}"
                    sh "rm -rf ${env.CHROME_DRIVER_DIR}"
                    echo "ChromeDriver directory removed."
                }
            }
            sh "find . -name '*.pyc' -delete || true"
            sh "find . -name '__pycache__' -type d -exec rm -rf {} + || true"
            echo "Other temporary files cleaned up."
        }
        success {
            echo 'Robot Framework tests completed successfully! üéâ'
        }
        failure {
            echo 'Robot Framework tests failed. Check logs for details. ‚ùå'
        }
    }
}